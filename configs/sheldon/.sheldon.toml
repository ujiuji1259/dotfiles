shell = "zsh"

[plugins.zsh-defer]
github = "romkatv/zsh-defer"
apply = ["source"]

[templates]
defer = "{{ hooks?.pre | nl }}{% for file in files %}zsh-defer source \"{{ file }}\"\n{% endfor %}{{ hooks?.post | nl }}"

[plugins.compinit]
inline = 'autoload -Uz compinit && zsh-defer compinit'

[plugins.zsh-syntax-highlighting]
github = "zdharma/fast-syntax-highlighting"
apply = ["defer"]

[plugins.zsh-completions]
github = "zsh-users/zsh-completions"
apply = ["defer"]

[plugins.autosuggestions]
github = "zsh-users/zsh-autosuggestions"
apply = ["defer"]

[plugins.zsh-abbr]
github = "olets/zsh-abbr"
apply = ["defer"]

[plugins.starship]
inline = 'eval "$(starship init zsh)"'

[plugins.history-fzf]
inline = '''
function fzf-select-history() {
    BUFFER=$(history -n -r 1 | fzf --query "$LBUFFER" --reverse)
    CURSOR=$#BUFFER
    zle reset-prompt
}
zle -N fzf-select-history
'''

[plugins.ghq-fzf]
inline = '''
changeSession() {
  local change
  [[ -n "${TMUX:-""}" ]] && change="switch-client" || change="attach-session"
  tmux $change -t "$1"
}

createSessionIfNeeded() {
  local name=$1
  [[ -n "$2" ]] && dir=$2 || dir=$(pwd)
  tmux list-sessions -F "#{session_name}" |
    grep -q -E "^${name}$" ||
    tmux new-session -d -c "${dir}" -s "${name}"
}

selectRepo() {
  echo "$(ghq root)/$(ghq list | fzf)"
}

tm() {
  if [ $# -eq 1 ]; then
    createSessionIfNeeded $1
    changeSession $1
    exit
  fi

  local repo="$(selectRepo)"
  local repo_name="$(echo "$repo" | awk -F/ '{ print $NF }')"

  # リポジトリ名に+が含まれている場合は、ブランチ選択をスキップ
  if [[ "$repo_name" == *"+"* ]]; then
    createSessionIfNeeded "$repo_name" "$repo"
    changeSession "$repo_name"
    return
  fi

  # ブランチを選択または新規作成
  local selected=$(
    (echo "[+ Create new branch]"; git -C "$repo" branch -a | \
      sed 's/^[*+ ]*//' | \
      sed 's/remotes\/origin\///' | \
      grep -v 'HEAD ->' | \
      sort -u) | \
    fzf --prompt="Select branch: " \
        --print-query \
        --height=50%)

  local query=$(echo "$selected" | sed -n '1p')
  local selection=$(echo "$selected" | sed -n '2p')

  # "[+ Create new branch]" が選択された場合は新規ブランチ作成
  if [ "$selection" = "[+ Create new branch]" ]; then
    echo -n "Enter new branch name: "
    read branch
  elif [ -z "$selection" ]; then
    local branch="$query"
  else
    local branch="$selection"
  fi

  branch=$(echo "$branch" | xargs)

  # ブランチが空の場合は終了
  if [ -z "$branch" ]; then
    echo "No branch selected"
    return 1
  fi

  # main or master ブランチの場合は元のリポジトリで作業
  if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
    createSessionIfNeeded "$repo_name" "$repo"
    changeSession "$repo_name"
    return
  fi

  # 既存のworktreeかチェック
  local existing_worktree=$(git -C "$repo" worktree list | grep "\[$branch\]" | awk '{print $1}')

  if [ -n "$existing_worktree" ]; then
    # 既存のworktreeを使用
    local session="${repo_name}+${branch}"
    createSessionIfNeeded "$session" "$existing_worktree"
    changeSession "$session"
    return
  fi

  # 最新の状態を取得
  echo "Fetching latest changes from remote..."
  git -C "$repo" fetch --quiet || {
    echo "Warning: Failed to fetch latest changes, proceeding with local state"
  }

  # worktree用のディレクトリとセッション名
  local session="${repo_name}+${branch}"
  local worktree_dir="$(ghq root)/${session}"

  # worktreeが既に存在するか確認
  if [ -d "$worktree_dir" ]; then
    # 既存のworktreeを使用
    createSessionIfNeeded "$session" "$worktree_dir"
    changeSession "$session"
    return
  fi

  # ブランチが存在するか確認
  if git -C "$repo" show-ref --verify --quiet "refs/heads/$branch"; then
    # ローカルブランチが存在する場合
    if ! git -C "$repo" worktree add "$worktree_dir" "$branch" 2>/dev/null; then
      echo "Error: Failed to create worktree for local branch '$branch'"
      echo "Possible causes:"
      echo "  - Worktree directory already exists: $worktree_dir"
      echo "  - Branch '$branch' is already checked out in another worktree"
      echo "Manual workaround:"
      echo "  git -C '$repo' worktree add '$worktree_dir' '$branch'"
      return 1
    fi
  elif git -C "$repo" show-ref --verify --quiet "refs/remotes/origin/$branch"; then
    # リモートブランチが存在する場合
    if ! git -C "$repo" worktree add "$worktree_dir" "$branch" 2>/dev/null; then
      echo "Error: Failed to create worktree for remote branch '$branch'"
      echo "Possible causes:"
      echo "  - Local branch '$branch' conflicts with remote tracking"
      echo "  - Worktree directory already exists: $worktree_dir"
      echo "Manual workaround:"
      echo "  git -C '$repo' worktree add '$worktree_dir' '$branch'"
      return 1
    fi
  else
    # 新規ブランチを作成（origin/mainベース）
    if ! git -C "$repo" worktree add -b "$branch" "$worktree_dir" "origin/main" 2>/dev/null; then
      echo "Error: Failed to create new worktree with branch '$branch' from origin/main"
      echo "Possible causes:"
      echo "  - origin/main does not exist (repository might use origin/master)"
      echo "  - Branch name '$branch' already exists"
      echo "  - Permission issues with directory: $worktree_dir"
      echo "Manual workarounds:"
      echo "  # If using master branch:"
      echo "  git -C '$repo' worktree add -b '$branch' '$worktree_dir' 'origin/master'"
      echo "  # Check existing branches:"
      echo "  git -C '$repo' branch -a"
      return 1
    fi
  fi

  createSessionIfNeeded "$session" "$worktree_dir"
  changeSession "$session"
}

zle -N tm
'''

[plugins.bindings]
inline = '''
bindkey '^r' fzf-select-history
'''

[plugins.worktree-remove]
inline = '''
tw-rm() {
  local worktree_list="for repo in \$(ghq list --full-path | grep -v '+'); do [ -d \"\$repo\" ] && git -C \"\$repo\" worktree list 2>/dev/null | tail -n +2 | awk -v repo=\"\$repo\" '{print \$1, repo}'; done | sort -u"

  eval "$worktree_list" | fzf \
    --prompt="Select worktree (Ctrl-D: delete, Enter: quit): " \
    --header="Press Ctrl-D to delete selected worktree" \
    --bind "ctrl-d:execute(
      git -C {2} worktree remove {1} && \
      echo 'Deleted: {1}' || echo 'Failed to delete: {1}'
    )+reload($worktree_list)"
}

zle -N tw-rm
'''
